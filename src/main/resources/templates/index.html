<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thynkah</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <style>
        .note-card-highlight {
            background-color: #fff7c2; /* soft yellow */
            transition: background-color 0.8s ease;
        }

        /* simple toast */
        #toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: none;
            z-index: 9999;
        }

        .note-card {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #fdfdfd;
        }
        .chip {
            display: inline-block;
            background-color: #eee;
            padding: 2px 8px;
            margin: 2px 4px 2px 0;
            border-radius: 12px;
            font-size: 0.85em;
            color: #333;
            cursor: pointer;
        }
    </style>

</head>

<body>

<h1>üß† Thynkah</h1>

<div id="headerArea">
    <nav class="navbar">
        <a th:href="@{/}">üß† Home</a>
        <a th:href="@{/calendar}">üìÖ Calendar</a>
    </nav>

    <textarea id="question" placeholder="Ask your brain something..."></textarea>
    <div style="margin-top: 0.5rem;">
        <button onclick="askQuestion()">Ask</button>
        <button onclick="savePrompt()">Save Prompt</button>
    </div>

    <select id="savedPrompts" onchange="fillPrompt(this)" style="margin-top: 0.5rem;">
        <option value="">üîΩ Select a saved prompt</option>
    </select>
</div>

<!-- updated 12.04.2025 -->

<!--<p id="response"></p>-->

<div style="margin-top: 0.5rem;">
    <strong>Answer:</strong>
    <p id="response"></p>
</div>

<div style="margin-top: 0.5rem;">
    <strong>Most relevant note:</strong>
    <p id="mostRelevantNote"></p>
</div>

<!-- end updated 12.04.2025 -->


<hr />

<div class="note-input-block">
    <div class="note-toolbar">
        <button type="button" onclick="wrapSelection('**','**')"><b>B</b></button>
        <button type="button" onclick="wrapSelection('_','_')"><i>I</i></button>
        <button type="button" onclick="insertPrefix('- ')">‚Ä¢</button>
        <button type="button" onclick="insertPrefix('1. ')">1.</button>
    </div>

    <textarea id="note"
              name="text"
              rows="8"
              placeholder="Paste your journal entry or idea... You can use **bold**, _italic_, etc."></textarea>
</div>

<input id="tag" placeholder="Tags (comma-separated)" />
<button onclick="uploadNote()">Upload Note</button>

<hr />



<h3>üìã Your Notes</h3>

<div style="margin-bottom:0.5rem;">
    <label for="noteSearch">Search notes (text or tags):</label>
    <input type="text" id="noteSearch" placeholder="Type to filter..." oninput="applySearchFilter()" />
</div>

<div id="dayFilter" style="margin-bottom: 0.5rem;">
    <label for="day">View notes for:</label>
    <input type="date" id="day" />
    <button onclick="showNotesForDay()">Show</button>
    <button onclick="clearDayFilter()">Show all</button>
    <button onclick="askAboutSelectedDay()">Ask about this day</button>
</div>

<div style="margin-top:0.5rem;">
    <strong>Day summary:</strong>
    <p id="daySummary"></p>
</div>
<div style="margin-top:0.5rem;">
    <strong>Most relevant note (that day):</strong>
    <p id="dayMostRelevant"></p>
</div>

<div id="notesPager" style="margin-bottom:0.5rem;"></div>
<div id="notesList"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let allNotes = []; // notes currently loaded (all or for a specific day)
    let currentPage = 0;
    let pageSize = 10;
    let totalPages = 1;

    /*part of highlight function*/
    function escapeRegExp(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function escapeHtml(str) {
        return (str || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    // very small markdown ‚Üí HTML renderer
    function renderMarkdown(text) {
        let html = escapeHtml(text || "");

        // **bold**
        html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

        // _italic_
        html = html.replace(/_(.+?)_/g, "<em>$1</em>");

        // line breaks
        html = html.replace(/\n/g, "<br>");

        return html;
    }

    function highlightText(text, query) {
        let html = renderMarkdown(text || "");

        const q = (query || "").trim();
        if (!q) return html;

        const pattern = new RegExp("(" + escapeRegExp(q) + ")", "gi");
        return html.replace(pattern, "<mark>$1</mark>");
    }


    /*part of highlight function*/

    async function uploadNote() {
        const text = document.getElementById("note").value;
        const tag = document.getElementById("tag").value;
        if (!text.trim()) return;
        await fetch("/notes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, tag }),
        });
        document.getElementById("note").value = "";
        document.getElementById("tag").value = "";
        loadNotes();
    }

    /*updated 12.04.2025 */








    async function askQuestion() {
        const questionEl = document.getElementById("question");
        const answerEl = document.getElementById("response");
        const noteEl = document.getElementById("mostRelevantNote");

        const question = (questionEl.value || "").trim();
        if (!question) {
            answerEl.innerText = "Please type a question first.";
            return;
        }

        answerEl.innerText = "Thinking...";
        noteEl.innerText = "";

        try {
            const res = await fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question }),
            });

            if (!res.ok) {
                answerEl.innerText = "Server error: " + res.status;
                return;
            }

            const data = await res.json();

            // AI-generated answer from NoteService.answerQuestion(...)
            answerEl.innerText = data.answer || "I couldn't generate an answer.";

            // Underneath, show which note was used (if any)
            if (data.noteText) {
                noteEl.innerText = data.noteText;
            } else {
                noteEl.innerText = "No relevant note found.";
            }

            // HIDE saved prompts (keep your existing behavior)
            document.getElementById("savedPrompts").style.display = "none";
        } catch (e) {
            console.error(e);
            answerEl.innerText = "Error talking to the server.";
        }
    }

    /*end updated 12.04.2025 */


    async function savePrompt() {
        const prompt = document.getElementById("question").value.trim();
        if (!prompt) return;
        await fetch("/prompts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
        });
        loadSavedPrompts();
    }

    async function loadSavedPrompts() {
        const res = await fetch("/prompts");
        const prompts = await res.json();
        const dropdown = document.getElementById("savedPrompts");
        dropdown.innerHTML = '<option value="">üîΩ Select a saved prompt</option>';
        prompts.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.prompt;
            opt.textContent = p.prompt;
            dropdown.appendChild(opt);
        });
    }

    function fillPrompt(select) {
        const selected = select.value;
        if (selected) {
            document.getElementById("question").value = selected;
        }
    }

    function renderNotes(notes, query) {
        const container = document.getElementById("notesList");
        container.innerHTML = "";

        const q = (query || "").trim();  // current search string

        notes.forEach(n => {
            const div = document.createElement("div");
            div.className = "note-card";
            div.id = `note-${n.id}`;   // <‚Äî for later highlighting


            const tags = (n.tag || "").split(",").map(t => t.trim()).filter(Boolean);
            const tagHTML = tags.length
                ? `<div id="tag-display-${n.id}">
                   ${tags
                    .map(tag => `<span class="chip">${highlightText(tag, q)}</span>`) //part of highlight function
                    .join(" ")}
               </div>`
                : `<div id="tag-display-${n.id}">
                   <em style="color:#aaa;">No tags</em>
               </div>`;

            const highlightedText = highlightText(n.text || "", q); //part of highlight function

            div.innerHTML = `
    ${tagHTML}
    <input id="tag-input-${n.id}" value="${n.tag || ""}" style="display:none; width:100%" />

    <p id="text-display-${n.id}" class="note-text">${highlightedText}</p>
    <textarea id="text-input-${n.id}" style="display:none;">${n.text}</textarea>

    <small style="color:#666;">üïí ${new Date(n.createdAt).toLocaleString()}</small>

<div class="note-actions" id="actions-${n.id}">
    <button onclick="enableTextEdit(${n.id})">‚úèÔ∏è</button>
    <button onclick="enableTagEdit(${n.id})">üè∑Ô∏è</button>
    <button onclick="askNoteCombined(${n.id})">üß†</button>
    <button onclick="showDeleteConfirm(${n.id})">üóëÔ∏è</button>
</div>

    <div class="note-actions" id="edit-actions-${n.id}" style="display:none;">
        <button onclick="submitEdits(${n.id})">üíæ</button>
        <button onclick="cancelEdits(${n.id})">‚ùå</button>
    </div>

    <div class="note-actions" id="confirm-delete-${n.id}" style="display:none;">
        <button onclick="deleteNote(${n.id})">‚úîÔ∏è</button>
        <button onclick="cancelDelete(${n.id})">‚ùå</button>
    </div>

<div id="note-ai-${n.id}" style="margin-top:0.5rem; font-size:0.9em; color:#333;"></div>

<button id="note-ai-save-${n.id}"
        style="display:none; margin-top:0.25rem; font-size:0.8em;"
        onclick="openAiSavePanel(${n.id})">
    Save AI as note
</button>

<div id="note-ai-panel-${n.id}"
     style="display:none; margin-top:0.5rem; border-top:1px solid #ddd; padding-top:0.5rem; font-size:0.85em;">
    <div style="margin-bottom:0.25rem;">
        <label>
            <input type="radio" name="ai-type-${n.id}" value="both">
            Both
        </label>
        <label>
            <input type="radio" name="ai-type-${n.id}" value="summary" checked>
            Summary
        </label>
        <label>
            <input type="radio" name="ai-type-${n.id}" value="tasks">
            Tasks
        </label>
    </div>

    <label>Tags:</label>
    <input type="text" id="note-ai-tags-${n.id}" style="width:100%; margin-bottom:0.25rem;" />

    <label>Note text:</label>
    <textarea id="note-ai-text-${n.id}" rows="4" style="width:100%;"></textarea>

    <div style="margin-top:0.25rem;">
        <button onclick="confirmSaveAiNote(${n.id})">Save</button>
        <button onclick="cancelSaveAiNote(${n.id})">Cancel</button>
    </div>
</div>

`;
            container.appendChild(div);
        });
    }

    function openAiSavePanel(id) {
        const aiDiv   = document.getElementById(`note-ai-${id}`);
        const panel   = document.getElementById(`note-ai-panel-${id}`);
        const tagsInp = document.getElementById(`note-ai-tags-${id}`);
        const textInp = document.getElementById(`note-ai-text-${id}`);

        if (!aiDiv || !panel || !tagsInp || !textInp) return;

        const aiText = (aiDiv.innerText || "").trim();
        textInp.value = aiText;
        tagsInp.value = "ai"; // or "ai, summary", etc.

        panel.style.display = "block";
    }

    function cancelSaveAiNote(id) {
        const panel = document.getElementById(`note-ai-panel-${id}`);
        if (panel) panel.style.display = "none";
    }



    async function loadNotes() {
        try {
            const res = await fetch(`/notes/page?page=${currentPage}&size=${pageSize}`);
            if (!res.ok) throw new Error("Failed to fetch notes page");
            const page = await res.json();

            allNotes = page.content;
            totalPages = page.totalPages;

            applySearchFilter();
            renderPager();
        } catch (e) {
            console.error("Error loading notes:", e);
        }
    }


    async function showNotesForDay() {
        const dayInput = document.getElementById("day");
        const date = (dayInput.value || "").trim();
        if (!date) {
            return; // nothing selected
        }

        try {
            const res = await fetch(`/notes/by-date?date=${encodeURIComponent(date)}`);
            if (!res.ok) throw new Error("Failed to fetch notes for date");
            const notes = await res.json();
            allNotes = notes;
            applySearchFilter(); // search within that day
        } catch (e) {
            console.error("Error loading notes for date:", e);
        }
    }

    function clearDayFilter() {
        const dayInput = document.getElementById("day");
        dayInput.value = "";
        loadNotes();
    }

    function applySearchFilter() {
        const searchInput = document.getElementById("noteSearch");
        const query = (searchInput ? searchInput.value : "").trim().toLowerCase();

        if (!query) {
            // no search ‚Üí show all loaded notes, no highlight
            renderNotes(allNotes, "");
            return;
        }

        const filtered = allNotes.filter(n => {
            const text = (n.text || "").toLowerCase();
            const tags = (n.tag || "").toLowerCase();
            return text.includes(query) || tags.includes(query);
        });

        renderNotes(filtered, query);
    }

    function filterByTag(tag) {
        const searchInput = document.getElementById("noteSearch");
        if (searchInput) {
            searchInput.value = tag;
        }
        applySearchFilter();
    }

    async function confirmSaveAiNote(id) {
        const panel   = document.getElementById(`note-ai-panel-${id}`);
        const tagsInp = document.getElementById(`note-ai-tags-${id}`);
        const textInp = document.getElementById(`note-ai-text-${id}`);
        if (!panel || !tagsInp || !textInp) return;

        const text = (textInp.value || "").trim();
        const tag  = (tagsInp.value || "").trim();
        if (!text) return;

        try {
            const res = await fetch("/notes", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text, tag })
            });

            if (!res.ok) {
                console.error("Save failed:", res.status);
                showToast("Failed to save AI note.");
                return;
            }

            const saved = await res.json(); // Note object with id

            panel.style.display = "none";
            await loadNotes();

            showToast("AI note saved.");
            if (saved && saved.id) {
                highlightNote(saved.id);
            }
        } catch (e) {
            console.error(e);
            showToast("Error while saving AI note.");
        }
    }

    function getTextarea() {
        return document.getElementById("note");
    }

    function wrapSelection(before, after) {
        const ta = getTextarea();
        const start = ta.selectionStart;
        const end   = ta.selectionEnd;

        const selected = ta.value.substring(start, end) || "";
        const wrapped = before + selected + after;

        ta.value = ta.value.substring(0, start) + wrapped + ta.value.substring(end);
        ta.focus();
        ta.selectionStart = start + before.length;
        ta.selectionEnd   = start + before.length + selected.length;
    }

    function insertPrefix(prefix) {
        const ta = getTextarea();
        const start = ta.selectionStart;
        const end   = ta.selectionEnd;

        // insert at start of current line(s)
        const value = ta.value;
        const lineStart = value.lastIndexOf("\n", start - 1) + 1;

        ta.value = value.substring(0, lineStart) + prefix + value.substring(lineStart);
        ta.focus();
        ta.selectionStart = start + prefix.length;
        ta.selectionEnd   = end + prefix.length;
    }

    function renderPager() {
        const el = document.getElementById("notesPager");
        if (!el) return;

        const windowSize = 5; // change to 3 if you want
        const total = Math.max(totalPages, 1);
        const current = currentPage; // 0-based

        // Compute start/end of window around current page
        const half = Math.floor(windowSize / 2);
        let start = Math.max(0, current - half);
        let end = Math.min(total - 1, start + windowSize - 1);
        start = Math.max(0, end - windowSize + 1);

        // Build page buttons
        let pagesHtml = "";
        for (let i = start; i <= end; i++) {
            const active = i === current;
            pagesHtml += `
  <button
    ${active ? "disabled" : ""}
    onclick="goToPage(${i})"
    style="${
                active
                    ? "font-weight:bold; background:#FF6F61; color:#fff; border:1px solid #FF6F61;"
                    : ""
            }">
    ${i + 1}
  </button>
`;
        }

        el.innerHTML = `
    <button ${current <= 0 ? "disabled" : ""} onclick="prevPage()">Prev</button>

    ${start > 0 ? `<button onclick="goToPage(0)">1</button><span>...</span>` : ""}

    ${pagesHtml}

    ${end < total - 1 ? `<span>...</span><button onclick="goToPage(${total - 1})">${total}</button>` : ""}

    <button ${current >= total - 1 ? "disabled" : ""} onclick="nextPage()">Next</button>

    <span style="margin-left:0.75rem;">Page ${current + 1} / ${total}</span>

    <span style="margin-left:0.75rem;">
      Jump:
      <input id="pageJump"
             type="number"
             min="1"
             max="${total}"
             style="width:70px;"
             placeholder="#"
             onkeydown="onJumpKey(event)" />
      <button onclick="jumpToPage()">Go</button>
    </span>
  `;
    }

    function goToPage(pageIndex) {
        const total = Math.max(totalPages, 1);
        const safe = Math.min(Math.max(pageIndex, 0), total - 1);
        if (safe === currentPage) return;
        currentPage = safe;
        loadNotes();
    }

    function jumpToPage() {
        const input = document.getElementById("pageJump");
        if (!input) return;

        const total = Math.max(totalPages, 1);
        const val = parseInt(input.value, 10);
        if (Number.isNaN(val)) return;

        // user enters 1-based page number
        const targetIndex = Math.min(Math.max(val, 1), total) - 1;
        goToPage(targetIndex);
    }

    function onJumpKey(e) {
        if (e.key === "Enter") jumpToPage();
    }


    function prevPage() { goToPage(currentPage - 1); }
    function nextPage() { goToPage(currentPage + 1); }





    async function askNoteCombined(id) {
        const prompt = `
You are Thynkah, a personal journaling assistant.
You see one diary note written in first person. Do TWO things:

1) Write a neutral 2‚Äì3 sentence summary of what happened and how the writer felt.

2) Then suggest at most 3 realistic "next steps" as a checklist.
   Each checklist item MUST:
   - Be an action the writer themself could reasonably take.
   - Be clearly implied or desired by the writer in the note
     (for example "I should...", "I want to...", "I need to...", or a very strong hint).
   - Be under the writer‚Äôs direct control.

Important constraints:
- Do NOT create tasks for things outside the writer‚Äôs control
  (e.g. cleaning or repairing company showers, changing other people, fixing public systems).
- Do NOT turn pure complaints or observations into tasks unless the writer explicitly
  indicates they want to act on it (e.g. "I should complain to the manager about the shower").
- If you‚Äôre unsure whether something is a task for the writer, leave it out.
- It is better to return fewer tasks than to invent ones.

Return plain text in this exact structure:

Summary:
<2‚Äì3 sentences>

Possible next steps:
- [ ] <task 1>
- [ ] <task 2>
- [ ] <task 3>

If there are no suitable actions, write:
Possible next steps:
No actionable tasks found for the user.
`;

        await askNoteWithPrompt(id, prompt);
    }


    async function askNoteWithPrompt(id, question) {
        const container = document.getElementById(`note-ai-${id}`);
        const saveBtn   = document.getElementById(`note-ai-save-${id}`);
        if (!container) return;

        container.innerText = "Thinking...";
        if (saveBtn) saveBtn.style.display = "none";

        try {
            const res = await fetch(`/ask/note/${id}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question })
            });

            if (!res.ok) {
                container.innerText = "Server error: " + res.status;
                return;
            }

            const data = await res.json();
            const answer = data.answer || "I couldn't generate anything for this note.";
            container.innerText = answer;

            if (saveBtn && answer.trim()) {
                saveBtn.style.display = "inline-block";
            }
        } catch (e) {
            console.error(e);
            container.innerText = "Error talking to the server.";
        }
    }

    function showToast(message) {
        const toast = document.getElementById("toast");
        if (!toast) return;

        toast.innerText = message;
        toast.style.display = "block";

        setTimeout(() => {
            toast.style.display = "none";
        }, 2000); // 2 seconds
    }

    function highlightNote(id) {
        const el = document.getElementById(`note-${id}`);
        if (!el) return;

        el.classList.add("note-card-highlight");
        setTimeout(() => {
            el.classList.remove("note-card-highlight");
        }, 1500); // highlight lasts 1.5 seconds
    }






    async function askAboutSelectedDay() {
        const dayInput = document.getElementById("day");
        const date = (dayInput.value || "").trim();

        const answerEl = document.getElementById("daySummary");
        const noteEl   = document.getElementById("dayMostRelevant");

        if (!date) {
            answerEl.innerText = "Select a day first.";
            noteEl.innerText = "";
            return;
        }

        answerEl.innerText = "Thinking...";
        noteEl.innerText   = "";

        try {
            const res = await fetch("/ask/day", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ date })
            });

            if (!res.ok) {
                answerEl.innerText = "Server error: " + res.status;
                return;
            }

            const data = await res.json();
            answerEl.innerText = data.answer || "I couldn't generate a summary.";

            if (data.noteText) {
                noteEl.innerText = data.noteText;
            } else {
                noteEl.innerText = "No single note stood out for that day.";
            }

            // ensure the list below also shows that day's notes
            await showNotesForDay();

        } catch (e) {
            console.error(e);
            answerEl.innerText = "Error talking to the server.";
        }
    }






    function enableTextEdit(id) {
        document.getElementById(`text-display-${id}`).style.display = "none";
        document.getElementById(`text-input-${id}`).style.display = "block";
        document.getElementById(`actions-${id}`).style.display = "none";
        document.getElementById(`edit-actions-${id}`).style.display = "flex";
    }

    function enableTagEdit(id) {
        document.getElementById(`tag-display-${id}`).style.display = "none";
        document.getElementById(`tag-input-${id}`).style.display = "block";
        document.getElementById(`actions-${id}`).style.display = "none";
        document.getElementById(`edit-actions-${id}`).style.display = "flex";
    }

    async function submitEdits(id) {
        const newText = document.getElementById(`text-input-${id}`).value;
        const newTag = document.getElementById(`tag-input-${id}`).value;

        const resText = await fetch(`/notes/${id}/text`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: newText }),
        });

        const resTag = await fetch(`/notes/${id}/tag`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tag: newTag }),
        });

        if (resText.ok && resTag.ok) {
            await loadNotes();
        }
    }

    function cancelEdits(id) {
        document.getElementById(`text-input-${id}`).style.display = "none";
        document.getElementById(`tag-input-${id}`).style.display = "none";
        document.getElementById(`text-display-${id}`).style.display = "block";
        document.getElementById(`tag-display-${id}`).style.display = "block";
        document.getElementById(`actions-${id}`).style.display = "flex";
        document.getElementById(`edit-actions-${id}`).style.display = "none";
    }

    function showDeleteConfirm(id) {
        document.getElementById(`actions-${id}`).style.display = "none";
        document.getElementById(`confirm-delete-${id}`).style.display = "flex";
    }

    function cancelDelete(id) {
        document.getElementById(`confirm-delete-${id}`).style.display = "none";
        document.getElementById(`actions-${id}`).style.display = "flex";
    }

    async function deleteNote(id) {
        await fetch(`/notes/${id}`, { method: "DELETE" });
        loadNotes();
    }

    window.onload = () => {
        loadNotes();
        loadSavedPrompts();

        const container = document.getElementById("notesList");
        container.addEventListener("click", function (e) {
            const chip = e.target.closest(".chip");
            if (!chip) return;

            const tagText = (chip.textContent || "").trim();
            filterByTag(tagText);
        });
    };

    /*]]>*/
</script>


<div id="toast"></div>
</body>
</html>
